services:
  seat-adjuster:
    build:
      context: .
      dockerfile: Dockerfile.ci
    # --- ADD THIS COMMAND OVERRIDE ---
    # Wait 10 seconds for Mosquitto to be ready, THEN start the app
    command: ["sh", "-c", "echo 'Waiting for Mosquitto...' && sleep 10 && /app/bin/example-seatadjusterapp & sleep infinity"]
    # ---------------------------------
    environment:
      - SDV_MQTT_ADDRESS=mosquitto:1883
      - MQTT_BROKER_HOST=mosquitto
      - MQTT_BROKER_PORT=1883
      - VEHICLEDATABROKER_ADDR=kuksa-databroker:55555
      - SDV_VEHICLEDATABROKER_ADDRESS=kuksa-databroker:55555

  integration-test-runner:
    environment:
      # Tell the Python script to use the container name, NOT localhost
      - BROKER_HOST=kuksa-databroker
      - BROKER_PORT=55555
      # Ensure output isn't buffered so we see logs instantly
      - PYTHONUNBUFFERED=1