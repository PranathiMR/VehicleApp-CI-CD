name: Module - Deploy S-CORE
on:
  workflow_call:
    inputs:
      image_uri:
        required: true
        type: string
      container_name:
        required: true
        type: string
      docker_run_args:
        required: false
        type: string
        default: "--network host"
    secrets:
      runner_token:
        required: true

jobs:
  deploy:
    runs-on: [self-hosted, score-target]
    steps:
      - name: Login
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.runner_token }}

      - name: Deploy Logic
        shell: powershell
        run: |
          $img = "${{ inputs.image_uri }}"
          $cName = "${{ inputs.container_name }}"
          
          # Pull the image
          docker pull $img

          # Stop Old Containers
          if (docker ps -a -q -f name=$cName) {
            Write-Host "Removing existing container..."
            docker rm -f $cName
          }

          # Start New Container
          docker run -d --name $cName --restart unless-stopped ${{ inputs.docker_run_args }} $img

          # 4. Verify if the container is running successfully
          sleep 5
          if ("$(docker inspect -f '{{.State.Running}}' $cName)" -eq "true") {
             Write-Host "✅ Deployment Successful"
          } else {
             Write-Host "❌ Failed to start"
             exit 1
          }