name: Reusable S-CORE Deployment

# This makes the workflow callable by other files
on:
  workflow_call:
    inputs:
      # The full Docker image URL (e.g., ghcr.io/user/app:tag)
      image_uri:
        required: true
        type: string
      # What to name the container (e.g., seat-adjuster)
      container_name:
        required: true
        type: string
      # Extra docker run arguments (e.g., ports, env vars)
      docker_run_args:
        required: false
        type: string
        default: "--network host"
    secrets:
      # We need the token to pull the private image
      registry_token:
        required: true

jobs:
  deploy-logic:
    name: Deploy ${{ inputs.container_name }}
    runs-on: [self-hosted, score-target]
    
    steps:
      # 1. Login (Generic)
      - name: Login to Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.registry_token }}

      # 2. Pull (Generic)
      - name: Pull Image
        run: docker pull ${{ inputs.image_uri }}

      # 3. Stop Old Container (Generic & Safe)
      - name: Stop Previous Deployment
        shell: powershell
        run: |
          $cName = "${{ inputs.container_name }}"
          if (docker ps -a -q -f name=$cName) {
            Write-Host "Found existing container $cName. Removing..."
            docker rm -f $cName
          } else {
            Write-Host "No previous container found. Skipping."
          }

      # 4. Start New Container (Generic)
      - name: Start Application
        run: |
          docker run -d `
            --name ${{ inputs.container_name }} `
            --restart unless-stopped `
            ${{ inputs.docker_run_args }} `
            ${{ inputs.image_uri }}

      # 5. Verify (Generic)
      - name: Verify Deployment
        shell: powershell
        run: |
          sleep 5
          $cName = "${{ inputs.container_name }}"
          if ("$(docker inspect -f '{{.State.Running}}' $cName)" -eq "true") {
            Write-Host "✅ Deployment Successful: $cName is running"
          } else {
            Write-Host "❌ Failed to start $cName"
            docker logs $cName
            exit 1
          }