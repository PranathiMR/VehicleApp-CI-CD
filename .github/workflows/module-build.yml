name: Module - Build & Test (SDK)

on:
  workflow_call:
    inputs:
      criticality:
        required: true
        type: string
        description: "Safety level: 'high' (fail on warnings) or 'low' (fail on errors)"
      cmake_target:
        required: true
        type: string
        description: "The CMake target name (e.g., example-seatadjusterapp)"
      source_dir:
        required: true
        type: string
        description: "Path to source code (e.g., examples/seat-adjuster)"

jobs:
  build-and-test:
    name: Build, Analyze & Test
    runs-on: ubuntu-latest
    # Uses the official Velocitas C++ SDK environment
    container: ghcr.io/eclipse-velocitas/devcontainer-base-images/cpp:latest
    
    steps:
      - uses: actions/checkout@v4
        with: { submodules: recursive }

      - name: Cache Conan Packages
        uses: actions/cache@v4
        with:
          path: /home/velocitas/.conan2
          key: ${{ runner.os }}-conan-${{ hashFiles('**/conanfile.py') }}
          restore-keys: ${{ runner.os }}-conan-

      - name: Install Dependencies
        working-directory: vehicle-app-cpp-sdk
        run: |
          chmod +x install_dependencies.sh
          ./install_dependencies.sh
          conan profile detect --force || true
          conan install . -s build_type=Release -of build-linux-x86_64/Release --build=missing

      # 1. COMPILATION (Build App & Tests)
      - name: Build App & Tests
        working-directory: vehicle-app-cpp-sdk
        run: |
          # Configure CMake with Tests ENABLED
          cmake -S . -B build-app \
            -DSDK_BUILD_EXAMPLES=ON \
            -DSDK_BUILD_TESTS=ON \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DCMAKE_TOOLCHAIN_FILE=build-linux-x86_64/Release/generators/conan_toolchain.cmake
          
          # Build the specific app target
          cmake --build build-app --target ${{ inputs.cmake_target }}
          
          # Build test targets (compiles the tests)
          cmake --build build-app

      # 2. STATIC ANALYSIS (Fail-Fast: Runs before Unit Tests)
      - name: Run Clang-Tidy
        working-directory: vehicle-app-cpp-sdk
        run: |
          find ${{ inputs.source_dir }} -name "*.cpp" | xargs clang-tidy -p build-app --header-filter=${{ inputs.source_dir }}/

      - name: Run CppCheck
        working-directory: vehicle-app-cpp-sdk
        run: |
          CHECK_OPTS="--enable=warning,performance --std=c++17"
          TARGET_DIR="${{ inputs.source_dir }}"
          
          if [ "${{ inputs.criticality }}" == "high" ]; then
             echo "ðŸš¨ High Criticality: Failing on WARNINGS"
             cppcheck $CHECK_OPTS --error-exitcode=1 $TARGET_DIR > cppcheck_report.txt 2>&1
          else
             echo "âš ï¸ Low Criticality: Failing on ERRORS only"
             cppcheck $CHECK_OPTS $TARGET_DIR > cppcheck_report.txt 2>&1
          fi

      - name: Upload Analysis Report
        if: always() 
        uses: actions/upload-artifact@v4
        with:
          name: analysis-report-${{ inputs.cmake_target }}
          path: vehicle-app-cpp-sdk/cppcheck_report.txt

      # 3. UNIT TESTS (Runs only if Static Analysis passes)
      - name: Run Unit Tests
        working-directory: vehicle-app-cpp-sdk/build-app
        run: ctest --output-on-failure

      # 4. ARTIFACT UPLOAD
      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          # Unique artifact name to prevent conflicts
          name: binary-${{ inputs.cmake_target }}
          path: vehicle-app-cpp-sdk/build-app/bin