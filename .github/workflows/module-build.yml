name: Module - Build & Test

on:
  workflow_call:
    inputs:
      criticality:
        required: true
        type: string

jobs:
  build-and-test:
    name: Build & Unit Test
    runs-on: ubuntu-latest
    container: ghcr.io/eclipse-velocitas/devcontainer-base-images/cpp:latest
    
    steps:
      - uses: actions/checkout@v4
        with: { submodules: recursive }

      - name: Cache Conan Packages
        id: cache-conan
        uses: actions/cache@v4
        with:
          path: /home/velocitas/.conan2
          key: ${{ runner.os }}-conan-${{ hashFiles('**/conanfile.py') }}
          restore-keys: ${{ runner.os }}-conan-

      - name: Install Dependencies & Config
        working-directory: vehicle-app-cpp-sdk
        run: |
          chmod +x install_dependencies.sh build.sh
          ./install_dependencies.sh
          conan profile detect --force || true
          conan install . -s build_type=Release -of build-linux-x86_64/Release --build=missing
          cmake -S . -B build-seat -DSDK_BUILD_EXAMPLES=ON -DSDK_BUILD_TESTS=OFF -DCMAKE_BUILD_TYPE=Release -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DCMAKE_TOOLCHAIN_FILE=build-linux-x86_64/Release/generators/conan_toolchain.cmake

      - name: Build Seat Adjuster
        working-directory: vehicle-app-cpp-sdk
        run: cmake --build build-seat --target example-seatadjusterapp

      # POINT 2: Conditional Static Analysis
      - name: Run CppCheck (Conditional Strictness)
        working-directory: vehicle-app-cpp-sdk
        run: |
          if [ "${{ inputs.criticality }}" == "high" ]; then
             echo "ðŸš¨ High Criticality: Failing on WARNINGS"
             # --error-exitcode=1 makes it fail on warnings
             cppcheck --enable=warning,performance --error-exitcode=1 --std=c++17 examples/seat-adjuster > cppcheck_report.txt 2>&1
          else
             echo "âš ï¸ Low Criticality: Failing on ERRORS only"
             # No --error-exitcode means warnings are just printed
             cppcheck --enable=warning,performance --std=c++17 examples/seat-adjuster > cppcheck_report.txt 2>&1
          fi

      # POINT 4: Upload Analysis Logs
      - name: Upload Analysis Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: static-analysis-report
          path: vehicle-app-cpp-sdk/cppcheck_report.txt

      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: seat-adjuster-bin
          path: vehicle-app-cpp-sdk/build-seat/bin