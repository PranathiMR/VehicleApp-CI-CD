name: Vehicle App CI Orchestrator

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  
  # Event trigger to select the criticality level
  workflow_dispatch:
    inputs:
      app_criticality:
        description: 'Select App Criticality'
        required: true
        default: 'low'
        type: choice
        options:
        - low
        - high

permissions:
  contents: read
  packages: write

jobs:
  # Configuration and Calculation of the global variables
  setup:
    runs-on: ubuntu-latest
    outputs:
      image_uri: ${{ steps.calc.outputs.image_uri }}
      criticality: ${{ steps.config.outputs.level }}
    steps:
      - id: calc
        run: |
          OWNER_LOWER="${GITHUB_REPOSITORY_OWNER,,}"
          FULL_URI="ghcr.io/${OWNER_LOWER}/vehicle-app"
          echo "image_uri=${FULL_URI}:sha-${{ github.sha }}" >> "$GITHUB_OUTPUT"
      
      - id: config
        # LOGIC: If manual input exists, use it. If triggered by push, default to 'low'.
        run: |
          INPUT_LEVEL="${{ inputs.app_criticality }}"
          if [ -z "$INPUT_LEVEL" ]; then
            echo "Triggered by Push: Defaulting to LOW criticality."
            echo "level=low" >> "$GITHUB_OUTPUT"
          else
            echo "Manual Trigger: Using $INPUT_LEVEL criticality."
            echo "level=$INPUT_LEVEL" >> "$GITHUB_OUTPUT"
          fi

  # Call the Build Module
  call-build:
    needs: setup
    uses: ./.github/workflows/module-build.yml
    with:
      # Pass the configuration calculated in setup
      criticality: ${{ needs.setup.outputs.criticality }}
      
      # Define the Vehicle App that needs to be built
      cmake_target: "example-seatadjusterapp"

      # Provide the path to the source code
      source_dir: "examples/seat-adjuster"

  # Call the Docker Module
  call-docker:
    needs: [setup, call-build]
    uses: ./.github/workflows/module-docker.yml
    with:
      image_uri: ${{ needs.setup.outputs.image_uri }}
      criticality: ${{ needs.setup.outputs.criticality }}
      
      # Provide the artifact name as generated by call-build
      artifact_name: "binary-example-seatadjusterapp"
      
      # Defines the path to the Dockerfile and the build binary
      context_path: "."
      binary_dest_path: "vehicle-app-cpp-sdk/build-seat/bin"
      
    secrets:
      registry_token: ${{ secrets.GITHUB_TOKEN }}

  # Call the Deployment Module
  call-deploy:
    needs: [setup, call-docker]
    # Only deploy if we are on the main branch
    if: github.ref == 'refs/heads/main'
    uses: ./.github/workflows/module-deploy.yml
    with:
      # Map the image_uri from setup to the input expected by the module
      image_uri: ${{ needs.setup.outputs.image_uri }}
      container_name: "seat-adjuster-service"
    secrets:
      runner_token: ${{ secrets.GITHUB_TOKEN }}

  # Verifies and Lists the artifacts stored.
  verify-artifacts:
    needs: [setup, call-build, call-docker]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Artifact Report
        run: |
          echo "Artifact Verification Report" >> $GITHUB_STEP_SUMMARY
          echo "Criticality Level Used: **${{ needs.setup.outputs.criticality }}**" >> $GITHUB_STEP_SUMMARY
          echo "Target Built: **example-seatadjusterapp**" >> $GITHUB_STEP_SUMMARY
          echo "- binary-example-seatadjusterapp (Build Artifact)" >> $GITHUB_STEP_SUMMARY
          echo "- analysis-report-example-seatadjusterapp (CppCheck)" >> $GITHUB_STEP_SUMMARY
          echo "- security-scan-results (Trivy)" >> $GITHUB_STEP_SUMMARY
          echo "- integration-test-logs (Runtime Logs)" >> $GITHUB_STEP_SUMMARY