name: Vehicle App CI Orchestrator

on:
  # 1. Automatic Trigger (Default behavior)
  push:
    branches: [ "main" ]
  
  # 2. Manual Trigger with Dropdown Input
  workflow_dispatch:
    inputs:
      app_criticality:
        description: 'Select App Criticality'
        required: true
        default: 'low'
        type: choice
        options:
        - low
        - high

permissions:
  contents: read
  packages: write

jobs:
  # ----------------------------------------------------------------
  # Stage 0: Setup & Configuration
  # ----------------------------------------------------------------
  setup:
    runs-on: ubuntu-latest
    outputs:
      image_uri: ${{ steps.calc.outputs.image_uri }}
      criticality: ${{ steps.config.outputs.level }}
    steps:
      - id: calc
        run: |
          OWNER_LOWER="${GITHUB_REPOSITORY_OWNER,,}"
          FULL_URI="ghcr.io/${OWNER_LOWER}/vehicle-app"
          echo "image_uri=${FULL_URI}:sha-${{ github.sha }}" >> "$GITHUB_OUTPUT"
      
      - id: config
        # LOGIC: If manual input exists, use it. If triggered by push, default to 'low'.
        run: |
          INPUT_LEVEL="${{ inputs.app_criticality }}"
          if [ -z "$INPUT_LEVEL" ]; then
            echo "Triggered by Push: Defaulting to LOW criticality."
            echo "level=low" >> "$GITHUB_OUTPUT"
          else
            echo "Manual Trigger: Using $INPUT_LEVEL criticality."
            echo "level=$INPUT_LEVEL" >> "$GITHUB_OUTPUT"
          fi

  # ----------------------------------------------------------------
  # Stage 1: Call Build Module
  # ----------------------------------------------------------------
  call-build:
    needs: setup
    uses: ./.github/workflows/module-build.yml
    with:
      # Pass the determined level (High/Low)
      criticality: ${{ needs.setup.outputs.criticality }}

  # ----------------------------------------------------------------
  # Stage 2: Call Docker Module
  # ----------------------------------------------------------------
  call-docker:
    needs: [setup, call-build]
    uses: ./.github/workflows/module-docker.yml
    with:
      image_uri: ${{ needs.setup.outputs.image_uri }}
      criticality: ${{ needs.setup.outputs.criticality }}
    secrets:
      registry_token: ${{ secrets.GITHUB_TOKEN }}

  # ----------------------------------------------------------------
  # Stage 3: Call Deploy Module
  # ----------------------------------------------------------------
  call-deploy:
    needs: [setup, call-docker]
    if: github.ref == 'refs/heads/main'
    uses: ./.github/workflows/module-deploy.yml
    with:
      image_uri: ${{ needs.setup.outputs.image_uri }}
      container_name: seat-adjuster
      docker_run_args: "-e SDV_MQTT_ADDRESS=mosquitto:1883 --network host"
    secrets:
      runner_token: ${{ secrets.GHCR_PAT }}

  # ----------------------------------------------------------------
  # Verify Artifacts
  # ----------------------------------------------------------------
  verify-artifacts:
    needs: [call-build, call-docker]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Artifact Report
        run: |
          echo "### ðŸ“¦ Artifact Verification Report" >> $GITHUB_STEP_SUMMARY
          echo "Criticality Level Used: **${{ needs.setup.outputs.criticality }}**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… seat-adjuster-bin" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… static-analysis-report" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… security-scan-results" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… integration-test-logs" >> $GITHUB_STEP_SUMMARY