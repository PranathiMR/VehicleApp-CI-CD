name: Vehicle App CI Orchestrator

on:
  # 1. Automatic Trigger (Default behavior)
  push:
    branches: [ "main" ]
  
  # 2. Manual Trigger with Dropdown Input
  workflow_dispatch:
    inputs:
      app_criticality:
        description: 'Select App Criticality'
        required: true
        default: 'low'
        type: choice
        options:
        - low
        - high

permissions:
  contents: read
  packages: write

jobs:
  # ----------------------------------------------------------------
  # Stage 0: Setup & Configuration
  # ----------------------------------------------------------------
  setup:
    runs-on: ubuntu-latest
    outputs:
      image_uri: ${{ steps.calc.outputs.image_uri }}
      criticality: ${{ steps.config.outputs.level }}
    steps:
      - id: calc
        run: |
          OWNER_LOWER="${GITHUB_REPOSITORY_OWNER,,}"
          FULL_URI="ghcr.io/${OWNER_LOWER}/vehicle-app"
          echo "image_uri=${FULL_URI}:sha-${{ github.sha }}" >> "$GITHUB_OUTPUT"
      
      - id: config
        # LOGIC: If manual input exists, use it. If triggered by push, default to 'low'.
        run: |
          INPUT_LEVEL="${{ inputs.app_criticality }}"
          if [ -z "$INPUT_LEVEL" ]; then
            echo "Triggered by Push: Defaulting to LOW criticality."
            echo "level=low" >> "$GITHUB_OUTPUT"
          else
            echo "Manual Trigger: Using $INPUT_LEVEL criticality."
            echo "level=$INPUT_LEVEL" >> "$GITHUB_OUTPUT"
          fi

  # ----------------------------------------------------------------
  # Stage 1: Call Build Module (The Factory)
  # ----------------------------------------------------------------
  call-build:
    needs: setup
    uses: ./.github/workflows/module-build.yml
    with:
      # CRITICAL: Pass the configuration calculated in setup
      criticality: ${{ needs.setup.outputs.criticality }}
      
      # APP SPECIFIC INPUTS (This is where you define WHAT to build)
      cmake_target: "example-seatadjusterapp"
      source_dir: "examples/seat-adjuster" # Path to your source code

  # ----------------------------------------------------------------
  # Stage 2: Call Docker Module (The Packager)
  # ----------------------------------------------------------------
  call-docker:
    needs: [setup, call-build]
    uses: ./.github/workflows/module-docker.yml
    with:
      image_uri: ${{ needs.setup.outputs.image_uri }}
      criticality: ${{ needs.setup.outputs.criticality }}
      
      # LINKING: Must match the artifact name generated by call-build
      artifact_name: "binary-example-seatadjusterapp"
      
      # PATHS: Where is the Dockerfile and where should the binary go?
      context_path: "."
      binary_dest_path: "vehicle-app-cpp-sdk/build-seat/bin"
      
    secrets:
      registry_token: ${{ secrets.GITHUB_TOKEN }}

  # ----------------------------------------------------------------
  # Stage 3: Call Deploy Module (The Virtual HiL)
  # ----------------------------------------------------------------
  call-deploy:
    needs: [setup, call-docker]
    # Only deploy if we are on the main branch
    if: github.ref == 'refs/heads/main'
    uses: ./.github/workflows/module-deploy.yml
    with:
      # Map the image_uri from setup to the input expected by the module
      image_uri: ${{ needs.setup.outputs.image_uri }}
      container_name: "seat-adjuster-service"
    secrets:
      runner_token: ${{ secrets.GITHUB_TOKEN }}

  # ----------------------------------------------------------------
  # Verify Artifacts (Reporting)
  # ----------------------------------------------------------------
  verify-artifacts:
    needs: [setup, call-build, call-docker]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Artifact Report
        run: |
          echo "### ðŸ“¦ Artifact Verification Report" >> $GITHUB_STEP_SUMMARY
          echo "Criticality Level Used: **${{ needs.setup.outputs.criticality }}**" >> $GITHUB_STEP_SUMMARY
          echo "Target Built: **example-seatadjusterapp**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… binary-example-seatadjusterapp (Build Artifact)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… analysis-report-example-seatadjusterapp (CppCheck)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… security-scan-results (Trivy)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… integration-test-logs (Runtime Logs)" >> $GITHUB_STEP_SUMMARY