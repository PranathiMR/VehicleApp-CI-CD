name: Vehicle App CI

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  # -------------------------------------------------
  # 1. Build SDK + Run SDK tests
  # -------------------------------------------------
  build:
    name: Build SDK and Run Tests
    runs-on: ubuntu-latest

    container:
      image: ghcr.io/eclipse-velocitas/devcontainer-base-images/cpp:latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Show tool versions
        run: |
          conan --version
          cmake --version
          gcc --version

      - name: Install dependencies
        working-directory: vehicle-app-cpp-sdk
        run: |
          chmod +x install_dependencies.sh
          ./install_dependencies.sh

      - name: Build SDK
        working-directory: vehicle-app-cpp-sdk
        run: |
          chmod +x build.sh
          ./build.sh

      - name: Run SDK tests (if present)
        working-directory: vehicle-app-cpp-sdk/build-linux-x86_64/Debug
        run: |
          if [ -f CTestTestfile.cmake ]; then
            ctest --output-on-failure
          else
            echo "No SDK tests found."
          fi

  # -------------------------------------------------
  # 2. Build Seat Adjuster + Static Analysis
  # -------------------------------------------------
  build-seat-adjuster:
    name: Build Seat Adjuster + Static Analysis
    runs-on: ubuntu-latest
    needs: build

    container:
      image: ghcr.io/eclipse-velocitas/devcontainer-base-images/cpp:latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Show tool versions
        run: |
          conan --version
          cmake --version
          gcc --version
          clang-tidy --version
          cppcheck --version

      - name: Install dependencies
        working-directory: vehicle-app-cpp-sdk
        run: |
          chmod +x install_dependencies.sh
          ./install_dependencies.sh

      - name: Configure Seat Adjuster
        working-directory: vehicle-app-cpp-sdk
        run: |
          cmake -S . -B build-seat \
            -DSDK_BUILD_EXAMPLES=ON \
            -DSDK_BUILD_TESTS=OFF \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DCMAKE_TOOLCHAIN_FILE=build-linux-x86_64/Release/generators/conan_toolchain.cmake

      - name: Build Seat Adjuster
        working-directory: vehicle-app-cpp-sdk
        run: |
          cmake --build build-seat --target example-seatadjusterapp

      - name: Run clang-tidy (non-blocking)
        working-directory: vehicle-app-cpp-sdk
        run: |
          clang-tidy \
            -p build-seat \
            examples/seat-adjuster/src/SeatAdjusterApp.cpp \
            --header-filter=examples/seat-adjuster/ \
            || true

      - name: Run cppcheck
        working-directory: vehicle-app-cpp-sdk
        run: |
          cppcheck \
            --enable=warning,performance,portability \
            --error-exitcode=1 \
            --std=c++17 \
            examples/seat-adjuster

      - name: Run Seat Adjuster tests
        working-directory: vehicle-app-cpp-sdk/build-seat
        run: |
          ctest --output-on-failure

      - name: Upload Seat Adjuster binary
        uses: actions/upload-artifact@v4
        with:
          name: seat-adjuster-bin
          path: vehicle-app-cpp-sdk/build-seat/bin

  # -------------------------------------------------
  # 3. Docker build + Trivy scan (HOST runner only)
  # -------------------------------------------------
  docker-and-security:
    name: Docker Build & Trivy Scan
    runs-on: ubuntu-latest
    needs: build-seat-adjuster

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download Seat Adjuster binary
        uses: actions/download-artifact@v4
        with:
          name: seat-adjuster-bin
          path: vehicle-app-cpp-sdk/build-seat/bin

      - name: Build Docker image
        run: |
          docker build -t vehicle-app:ci .

      - name: Run Trivy scan (fail only on HIGH,CRITICAL)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: vehicle-app:ci
          format: table
          exit-code: 1
          severity: HIGH,CRITICAL

  # -------------------------------------------------
  # 4. Integration Tests (Docker Compose)
  # -------------------------------------------------
  integration-test:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    needs: build-seat-adjuster
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download Seat Adjuster binary
        uses: actions/download-artifact@v4
        with:
          name: seat-adjuster-bin
          path: vehicle-app-cpp-sdk/build-seat/bin

      - name: Setup Configuration Files
        run: |
          # 1. Create mosquitto.conf
          echo "listener 1883" > mosquitto.conf
          echo "allow_anonymous true" >> mosquitto.conf

          # 2. Create vss.json
          cat <<EOF > vss.json
          {
            "Vehicle": {
              "type": "branch",
              "description": "The vehicle root",
              "children": {
                "Speed": {
                  "type": "sensor",
                  "datatype": "float",
                  "unit": "km/h",
                  "description": "Vehicle Speed"
                },
                "Cabin": {
                  "type": "branch",
                  "description": "The vehicle cabin",
                  "children": {
                    "Seat": {
                      "type": "branch",
                      "description": "Seats in the cabin",
                      "children": {
                        "Row1": {
                          "type": "branch",
                          "description": "Row 1",
                          "children": {
                            "Pos1": {
                              "type": "branch",
                              "description": "Position 1",
                              "children": {
                                "Position": {
                                  "type": "actuator",
                                  "datatype": "uint8",
                                  "unit": "percent",
                                  "min": 0,
                                  "max": 100,
                                  "description": "Seat position on the longitudinal axis"
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
          EOF

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # --- CHANGED: Setup Artifact Directory ---
      - name: Create Log Directory
        run: mkdir -p test-artifacts

      - name: Run Integration Test
        id: run_tests
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml up --build --exit-code-from integration-test-runner

      # --- CHANGED: Dump logs to file and upload ---
      - name: Dump Docker Logs to File
        if: always()
        run: |
          # Save full logs to a text file for download
          docker compose logs > test-artifacts/docker_full_logs.txt
          
          # Print last 100 lines to console for quick checks
          echo "=== LAST 100 LINES OF LOGS ==="
          tail -n 100 test-artifacts/docker_full_logs.txt

      - name: Teardown
        if: always()
        run: docker compose down

      - name: Upload Logs as Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-logs
          path: test-artifacts/
          retention-days: 5

  # -------------------------------------------------
  # 5. Release Pipeline (Covers Stages 2.8 & 2.9)
  # -------------------------------------------------
  release-image:
    name: Build & Publish Release
    runs-on: ubuntu-latest
    # Run only if tests pass AND we are on the 'main' branch
    needs: [integration-test, docker-and-security]
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      packages: write  # Required to push to GHCR

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # -------------------------------------------------
      # STAGE 2.8 PREP: Get the binary
      # We need the compiled C++ binary to build the final image
      # -------------------------------------------------
      - name: Download Seat Adjuster Binary
        uses: actions/download-artifact@v4
        with:
          name: seat-adjuster-bin
          path: vehicle-app-cpp-sdk/build-seat/bin

      - name: Lowercase Repo Name
        run: |
          echo "REPO_LOWER=${GITHUB_REPOSITORY,,}" >> ${GITHUB_ENV}

      # -------------------------------------------------
      # STAGE 2.8: Build and Tag Release
      # We prepare the tags (SHA for traceability, Latest for convenience)
      # -------------------------------------------------
      - name: Generate Docker Metadata (Tags)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/vehicle-app
          tags: |
            type=raw,value=latest
            type=sha,format=long

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # -------------------------------------------------
      # STAGE 2.9: Publish to Registry
      # We build the image using the PROD Dockerfile and push immediately
      # -------------------------------------------------
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          # Use the standard production Dockerfile (not .ci)
          file: Dockerfile
          push: true
          # These tags (sha-xxxxx and latest) ensure traceability
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # -------------------------------------------------
  # 6. Deploy to S-CORE (Calling the Abstract Workflow)
  # -------------------------------------------------
  deploy-score:
    name: Trigger S-CORE Deployment
    needs: release-image
    if: github.ref == 'refs/heads/main'
    
    # CALL THE REUSABLE WORKFLOW FILE
    uses: ./.github/workflows/cd-deploy.yml
    with:
      # We calculate the lowercase URI here, before passing it
      image_uri: ghcr.io/pranathimr/vehicle-app:sha-${{ github.sha }}
      container_name: seat-adjuster
      docker_run_args: "-e SDV_MQTT_ADDRESS=mosquitto:1883 --network host"
    secrets:
      registry_token: ${{ secrets.GHCR_PAT }}