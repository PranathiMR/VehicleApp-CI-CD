name: Vehicle App CI

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  # -------------------------------------------------
  # 1. Build SDK + Run SDK tests
  # -------------------------------------------------
  build:
    name: Build SDK and Run Tests
    runs-on: ubuntu-latest

    container:
      image: ghcr.io/eclipse-velocitas/devcontainer-base-images/cpp:latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Show tool versions
        run: |
          conan --version
          cmake --version
          gcc --version

      - name: Install dependencies
        working-directory: vehicle-app-cpp-sdk
        run: |
          chmod +x install_dependencies.sh
          ./install_dependencies.sh

      - name: Build SDK
        working-directory: vehicle-app-cpp-sdk
        run: |
          chmod +x build.sh
          ./build.sh

      - name: Run SDK tests (if present)
        working-directory: vehicle-app-cpp-sdk/build-linux-x86_64/Debug
        run: |
          if [ -f CTestTestfile.cmake ]; then
            ctest --output-on-failure
          else
            echo "No SDK tests found."
          fi

  # -------------------------------------------------
  # 2. Build Seat Adjuster + Static Analysis
  # -------------------------------------------------
  build-seat-adjuster:
    name: Build Seat Adjuster + Static Analysis
    runs-on: ubuntu-latest
    needs: build

    container:
      image: ghcr.io/eclipse-velocitas/devcontainer-base-images/cpp:latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Show tool versions
        run: |
          conan --version
          cmake --version
          gcc --version
          clang-tidy --version
          cppcheck --version

      - name: Install dependencies
        working-directory: vehicle-app-cpp-sdk
        run: |
          chmod +x install_dependencies.sh
          ./install_dependencies.sh

      - name: Configure Seat Adjuster
        working-directory: vehicle-app-cpp-sdk
        run: |
          cmake -S . -B build-seat \
            -DSDK_BUILD_EXAMPLES=ON \
            -DSDK_BUILD_TESTS=OFF \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DCMAKE_TOOLCHAIN_FILE=build-linux-x86_64/Release/generators/conan_toolchain.cmake

      - name: Build Seat Adjuster
        working-directory: vehicle-app-cpp-sdk
        run: |
          cmake --build build-seat --target example-seatadjusterapp

      - name: Run clang-tidy (non-blocking)
        working-directory: vehicle-app-cpp-sdk
        run: |
          clang-tidy \
            -p build-seat \
            examples/seat-adjuster/src/SeatAdjusterApp.cpp \
            --header-filter=examples/seat-adjuster/ \
            || true

      - name: Run cppcheck
        working-directory: vehicle-app-cpp-sdk
        run: |
          cppcheck \
            --enable=warning,performance,portability \
            --error-exitcode=1 \
            --std=c++17 \
            examples/seat-adjuster

      - name: Run Seat Adjuster tests
        working-directory: vehicle-app-cpp-sdk/build-seat
        run: |
          ctest --output-on-failure

      - name: Upload Seat Adjuster binary
        uses: actions/upload-artifact@v4
        with:
          name: seat-adjuster-bin
          path: vehicle-app-cpp-sdk/build-seat/bin

  # -------------------------------------------------
  # 3. Docker build + Trivy scan (HOST runner only)
  # -------------------------------------------------
  docker-and-security:
    name: Docker Build & Trivy Scan
    runs-on: ubuntu-latest
    needs: build-seat-adjuster

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download Seat Adjuster binary
        uses: actions/download-artifact@v4
        with:
          name: seat-adjuster-bin
          path: vehicle-app-cpp-sdk/build-seat/bin

      - name: Build Docker image
        run: |
          docker build -t vehicle-app:ci .

      - name: Run Trivy scan (fail only on HIGH,CRITICAL)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: vehicle-app:ci
          format: table
          exit-code: 1
          severity: HIGH,CRITICAL

# -------------------------------------------------
  # 4. Integration Tests (Docker Compose)
  # -------------------------------------------------
  integration-test:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    needs: build-seat-adjuster  # We rely on the binary built here
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download Seat Adjuster binary
        uses: actions/download-artifact@v4
        with:
          name: seat-adjuster-bin
          # We download it to the exact path Dockerfile.ci expects
          path: vehicle-app-cpp-sdk/build-seat/bin

      - name: Setup Configuration Files
        # Generate the required config files dynamically
        run: |
          # 1. Create mosquitto.conf
          echo "listener 1883" > mosquitto.conf
          echo "allow_anonymous true" >> mosquitto.conf

          # 2. Create vss.json (The one we fixed together)
          cat <<EOF > vss.json
          {
            "Vehicle": {
              "type": "branch",
              "description": "The vehicle root",
              "children": {
                "Speed": {
                  "type": "sensor",
                  "datatype": "float",
                  "unit": "km/h",
                  "description": "Vehicle Speed"
                },
                "Cabin": {
                  "type": "branch",
                  "description": "The vehicle cabin",
                  "children": {
                    "Seat": {
                      "type": "branch",
                      "description": "Seats in the cabin",
                      "children": {
                        "Row1": {
                          "type": "branch",
                          "description": "Row 1",
                          "children": {
                            "Pos1": {
                              "type": "branch",
                              "description": "Position 1",
                              "children": {
                                "Position": {
                                  "type": "actuator",
                                  "datatype": "uint8",
                                  "unit": "percent",
                                  "min": 0,
                                  "max": 100,
                                  "description": "Seat position on the longitudinal axis"
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
          EOF

      - name: Run Integration Test
        # We use -f to combine the base config with the CI override
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml up --build --exit-code-from integration-test-runner

      - name: Dump Docker Logs (On Failure)
        if: failure()
        run: docker compose logs

      - name: Teardown
        if: always()
        run: docker compose down

