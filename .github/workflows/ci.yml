name: Vehicle App CI

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  # -------------------------------------------------
  # 1. Build SDK + Run SDK tests
  # -------------------------------------------------
  build:
    name: Build SDK and Run Tests
    runs-on: ubuntu-latest

    container:
      image: ghcr.io/eclipse-velocitas/devcontainer-base-images/cpp:latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Show tool versions
        run: |
          conan --version
          cmake --version
          gcc --version

      - name: Install dependencies
        working-directory: vehicle-app-cpp-sdk
        run: |
          chmod +x install_dependencies.sh
          ./install_dependencies.sh

      - name: Build SDK
        working-directory: vehicle-app-cpp-sdk
        run: |
          chmod +x build.sh
          ./build.sh

      - name: Run SDK tests (if present)
        working-directory: vehicle-app-cpp-sdk/build-linux-x86_64/Debug
        run: |
          if [ -f CTestTestfile.cmake ]; then
            ctest --output-on-failure
          else
            echo "No SDK tests found."
          fi

  # -------------------------------------------------
  # 2. Build Seat Adjuster + Static Analysis
  # -------------------------------------------------
  build-seat-adjuster:
    name: Build Seat Adjuster + Static Analysis
    runs-on: ubuntu-latest
    needs: build

    container:
      image: ghcr.io/eclipse-velocitas/devcontainer-base-images/cpp:latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Show tool versions
        run: |
          conan --version
          cmake --version
          gcc --version
          clang-tidy --version
          cppcheck --version

      - name: Install dependencies
        working-directory: vehicle-app-cpp-sdk
        run: |
          chmod +x install_dependencies.sh
          ./install_dependencies.sh

      - name: Configure Seat Adjuster
        working-directory: vehicle-app-cpp-sdk
        run: |
          cmake -S . -B build-seat \
            -DSDK_BUILD_EXAMPLES=ON \
            -DSDK_BUILD_TESTS=OFF \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DCMAKE_TOOLCHAIN_FILE=build-linux-x86_64/Release/generators/conan_toolchain.cmake

      - name: Build Seat Adjuster
        working-directory: vehicle-app-cpp-sdk
        run: |
          cmake --build build-seat --target example-seatadjusterapp

      - name: Run clang-tidy (non-blocking)
        working-directory: vehicle-app-cpp-sdk
        run: |
          clang-tidy \
            -p build-seat \
            examples/seat-adjuster/src/SeatAdjusterApp.cpp \
            --header-filter=examples/seat-adjuster/ \
            || true

      - name: Run cppcheck
        working-directory: vehicle-app-cpp-sdk
        run: |
          cppcheck \
            --enable=warning,performance,portability \
            --error-exitcode=1 \
            --std=c++17 \
            examples/seat-adjuster

      - name: Run Seat Adjuster tests
        working-directory: vehicle-app-cpp-sdk/build-seat
        run: |
          ctest --output-on-failure

      - name: Upload Seat Adjuster binary
        uses: actions/upload-artifact@v4
        with:
          name: seat-adjuster-bin
          path: vehicle-app-cpp-sdk/build-seat/bin

  # -------------------------------------------------
  # 3. Docker build + Trivy scan (HOST runner only)
  # -------------------------------------------------
  docker-and-security:
    name: Docker Build & Trivy Scan
    runs-on: ubuntu-latest
    needs: build-seat-adjuster

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download Seat Adjuster binary
        uses: actions/download-artifact@v4
        with:
          name: seat-adjuster-bin
          path: vehicle-app-cpp-sdk/build-seat/bin

      - name: Build Docker image
        run: |
          docker build -t vehicle-app:ci .

      - name: Install Trivy
        run: |
          wget -q https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.50.0_Linux-64bit.tar.gz
          tar -xzf trivy_0.50.0_Linux-64bit.tar.gz
          sudo mv trivy /usr/local/bin/

      - name: Run Trivy scan (fail only on HIGH,CRITICAL)
        run: |
          trivy image \
            --exit-code 1 \
            --severity HIGH,CRITICAL \
            --no-progress \
            vehicle-app:ci
