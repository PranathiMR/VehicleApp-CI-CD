name: Vehicle App CI

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  build:
    name: Build SDK and Run Tests
    runs-on: ubuntu-latest

    container:
      image: ghcr.io/eclipse-velocitas/devcontainer-base-images/cpp:latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Show tool versions
        run: |
          conan --version
          cmake --version
          gcc --version

      - name: Install dependencies
        working-directory: vehicle-app-cpp-sdk
        run: |
          chmod +x install_dependencies.sh
          ./install_dependencies.sh

      - name: Build SDK
        working-directory: vehicle-app-cpp-sdk
        run: |
          chmod +x build.sh
          ./build.sh

      - name: Run tests (if present)
        working-directory: vehicle-app-cpp-sdk/build-linux-x86_64/Debug
        run: |
          if [ -f CTestTestfile.cmake ]; then
            ctest --output-on-failure
          else
            echo "No tests found."
          fi

  build-seat-adjuster:
    name: Build Seat Adjuster App + Static Analysis
    runs-on: ubuntu-latest

    container:
      image: ghcr.io/eclipse-velocitas/devcontainer-base-images/cpp:latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Show tool versions
        run: |
          conan --version
          cmake --version
          gcc --version
          clang-tidy --version
          cppcheck --version

      - name: Install dependencies
        working-directory: vehicle-app-cpp-sdk
        run: |
          chmod +x install_dependencies.sh
          ./install_dependencies.sh

      - name: Configure Seat Adjuster (export compile commands)
        working-directory: vehicle-app-cpp-sdk
        run: |
          cmake -S . -B build-seat \
            -DSDK_BUILD_EXAMPLES=ON \
            -DSDK_BUILD_TESTS=OFF \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DCMAKE_TOOLCHAIN_FILE=build-linux-x86_64/Debug/generators/conan_toolchain.cmake

      - name: Build Seat Adjuster only
        working-directory: vehicle-app-cpp-sdk
        run: |
          cmake --build build-seat --target example-seatadjusterapp

      - name: Run clang-tidy on Seat Adjuster
        working-directory: vehicle-app-cpp-sdk
        run: |
          clang-tidy \
            -p build-seat \
            examples/seat-adjuster/src/SeatAdjusterApp.cpp \
            --header-filter=examples/seat-adjuster/ \
            || true

      - name: Run cppcheck on Seat Adjuster
        working-directory: vehicle-app-cpp-sdk
        run: |
          cppcheck \
            --enable=warning,performance,portability \
            --error-exitcode=1 \
            --std=c++17 \
            examples/seat-adjuster

      - name: Run Seat Adjuster unit tests
        working-directory: vehicle-app-cpp-sdk/build-seat
        run: |
          ctest --output-on-failure
